<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cockpit Rundown</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: #8B0000; /* Dark Red */
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .header h2 {
            margin: 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .clock {
            font-size: 1.5em;
        }

        .tabs {
            background-color: #B22222; /* Lighter Red */
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .tabs button {
            background-color: #DC143C; /* Crimson */
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }

        .tabs button.active {
            background-color: #FF6347; /* Tomato */
        }

        .tabs button.blink-red {
            animation: blink 1s infinite;
            background-color: red;
        }

        .tabs button.blink-green {
            background-color: green;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left, .right {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .left {
            border-right: 2px solid #ccc;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 5px;
            text-align: left;
        }

        th:nth-child(1), td:nth-child(1) {
            width: 10%;
            text-align: center;
        }

        th:nth-child(2), td:nth-child(2) {
            width: 10%;
            text-align: center;
        }

        th:nth-child(3), td:nth-child(3) {
            width: 15%; /* Adjusted for Nr. */
            text-align: center;
        }

        th:nth-child(4), td:nth-child(4) {
            width: 55%;
        }

        th:nth-child(5), td:nth-child(5) {
            width: 10%;
            text-align: center;
        }

        tr.blink-red {
            background-color: red;
            animation: blink 1s infinite;
        }

        tr.blink-green {
            background-color: green;
            color: white;
        }

        tr.completed {
            background-color: lightgray;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .expanded {
            display: none;
        }

        .expanded.visible {
            display: table-row;
        }

        .player-container {
            width: 100%;
            height: calc(100% - 40px);
        }

        video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="clock" id="clock-left"></div>
        <div class="header-title">
            <h1>Cockpit Rundown</h1>
            <h2>WEC Ocala</h2>
        </div>
        <div class="clock" id="clock-right"></div>
    </div>

    <div class="tabs" id="tabs-container"></div>

    <div class="content">
        <div class="left">
            <table id="schedule-table">
                <thead>
                    <tr>
                        <th>Prepare</th>
                        <th>Starttime</th>
                        <th>Nr.</th>
                        <th>Competition</th>
                        <th>Entries</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="right">
            <div class="player-container">
                <video id="hls-player" autoplay muted controls></video>
            </div>
        </div>
    </div>

    <script>
        const clockLeft = document.getElementById('clock-left');
        const clockRight = document.getElementById('clock-right');
        const tabsContainer = document.getElementById('tabs-container');
        const tableBody = document.querySelector('#schedule-table tbody');
        const hlsPlayer = document.getElementById('hls-player');

        const defaultStream = "https://ingest-fhdinternational.clipmyhorse.tv:9443/ingest/outstream_low/playlist.m3u8";

        let tabs = [];
        let scheduleData = [];

        function updateClock() {
            const now = new Date();
            const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const timeString = now.toLocaleTimeString('en-US', options);
            clockLeft.textContent = timeString;
            clockRight.textContent = timeString;
        }

        setInterval(updateClock, 1000);
        updateClock();

        function loadCSV() {
            fetch('cockpitrundownupload.csv')
                .then(response => response.text())
                .then(csvText => {
                    const rows = csvText.split('\n').map(row => row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
                    const [headers, ...data] = rows;

                    tabs = [...new Set(data.map(row => row[0]?.trim()))];
                    scheduleData = data.map(row => ({
                        tab: row[0]?.trim() || "Default",
                        prepare: row[1]?.trim(),
                        starttime: row[2]?.trim(),
                        number: row[3]?.trim(),
                        competition: row[4]?.trim(),
                        entries: row[5]?.trim(),
                        details: row[6]?.trim(),
                        stream: row[7]?.trim() || defaultStream
                    }));

                    renderTabs();
                    renderTable(tabs[0]);
                })
                .catch(error => console.error("CSV konnte nicht geladen werden:", error));
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.textContent = tab;
                button.classList.add('tab-button');
                button.classList.toggle('active', index === 0);
                button.onclick = () => {
                    document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderTable(tab);
                };
                tabsContainer.appendChild(button);
            });
        }

        function renderTable(tab) {
            const filteredData = scheduleData.filter(row => row.tab === tab);
            tableBody.innerHTML = '';
            const tabButton = document.querySelector(`.tabs button:nth-child(${tabs.indexOf(tab) + 1})`);

            let hasBlinkRed = false;
            let hasGreen = false;

            filteredData.sort((a, b) => new Date(a.prepare) - new Date(b.prepare));

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const expandedRow = document.createElement('tr');
                expandedRow.className = 'expanded';

                tr.innerHTML = `
                    <td>${formatTime(row.prepare)}</td>
                    <td>${formatTime(row.starttime)}</td>
                    <td>${row.number}</td>
                    <td>${row.competition}</td>
                    <td>${row.entries}</td>
                `;

                expandedRow.innerHTML = `<td colspan="5">${row.details}</td>`;

                tr.onclick = () => expandedRow.classList.toggle('visible');

                tableBody.appendChild(tr);
                tableBody.appendChild(expandedRow);

                const prepareTime = convertToTimezone(new Date(row.prepare).getTime(), -5);
                const startTime = convertToTimezone(new Date(row.starttime).getTime(), -5);
                const nextRowStartTime = index < filteredData.length - 1 ? convertToTimezone(new Date(filteredData[index + 1].starttime).getTime(), -5) : Infinity;

                setInterval(() => {
                    const now = convertToTimezone(Date.now(), -5);

                    if (now >= startTime && now < nextRowStartTime) {
                        tr.classList.remove('blink-red');
                        tr.classList.add('blink-green');
                        hasGreen = true;
                    } else if (now >= prepareTime && now < startTime) {
                        tr.classList.add('blink-red');
                        hasBlinkRed = true;
                    } else {
                        tr.classList.remove('blink-green', 'blink-red');
                    }

                    // Ensure the last entry doesn't stay green after its time window ends
                    if (index === filteredData.length - 1 && now >= nextRowStartTime) {
                        tr.classList.remove('blink-green', 'blink-red');
                    }

                    if (hasBlinkRed) {
                        tabButton.classList.add('blink-red');
                        tabButton.classList.remove('blink-green');
                    } else if (hasGreen) {
                        tabButton.classList.add('blink-green');
                        tabButton.classList.remove('blink-red');
                    } else {
                        tabButton.classList.remove('blink-red', 'blink-green');
                    }
                }, 1000);
            });

            const streamUrl = filteredData[0]?.stream || defaultStream;
            loadStream(streamUrl);
        }

        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function convertToTimezone(timestamp, offset) {
            const utc = timestamp - new Date().getTimezoneOffset() * 60000;
            return utc + offset * 3600000;
        }

        function loadStream(url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(hlsPlayer);

                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error("HLS.js Error:", data);
                });
            } else if (hlsPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                hlsPlayer.src = url;
            } else {
                console.error("HLS.js is not supported in this browser.");
            }
        }

        loadCSV();
    </script>
</body>
</html>
